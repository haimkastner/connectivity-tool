name: connectivity-tool

on:
  # Trigger workflow on push or manual dispatch ğŸ¯
  [ push, workflow_dispatch ]

jobs:
  build:
    runs-on: ubuntu-latest # ğŸŒ Use the latest Ubuntu image for this job

    steps:
      # Step 1ï¸âƒ£: Checkout the repository code ğŸ“‚
      - uses: actions/checkout@v4
        name: ğŸ› ï¸ Checkout Code

      # Step 2ï¸âƒ£: Set up Python environment ğŸ
      - uses: actions/setup-python@v5
        name: ğŸ”§ Set Up Python
        with:
          python-version: '3.10' # Specify Python version ğŸ”¢

      # Step 3ï¸âƒ£: Install dependencies and build ğŸ”¨
      - name: ğŸ—ï¸ Build Project
        run: |
          echo "Installing dependencies ğŸ“¦..."
          pip install -r requirements.txt
          echo "Installing the connectivity tool ğŸš€..."
          pip install .
          echo "showing the installed packages"
          connectivity_tool -i

      # Step 4ï¸âƒ£: Run unit tests ğŸ§ª
      - name: ğŸ§¹ Test Units
        run: |
          echo "Running tests ğŸ”..."
          pip install coverage coveralls  # Install coverage and coveralls
          coverage run -m unittest discover tests  # Run tests with coverage

      # Step 5ï¸âƒ£: Upload coverage to Coveralls ğŸ“
      - name: ğŸ“Š Upload coverage to Coveralls
        run: |
          coveralls  # Send coverage data to Coveralls

      # Step 6ï¸âƒ£: Bump the version automatically ğŸ”„
      - name: ğŸ”¼ Bump Version
        if: github.ref == 'refs/heads/main' # Run only on the main branch
        id: update_version
        run: |
          echo "Fetching the current version ğŸ”..."
          VERSION=$(python setup.py --version)
          echo "Current version: $VERSION"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION" # Split version into parts
          PATCH=$((PATCH + 1)) # Increment the PATCH version
          NEXT_VERSION="$MAJOR.$MINOR.$PATCH" # Form the next version
          echo "Updating setup.py with version: $NEXT_VERSION âœ¨..."
          sed -i "s/version = '.*'/version = '$NEXT_VERSION'/g" setup.py
          echo "VERSION=$NEXT_VERSION" >> $GITHUB_OUTPUT

      # Step 7ï¸âƒ£: Retrieve version info for release notes ğŸ“œ
      - name: ğŸ“ Get Version Info
        id: version_info
        run: |
          echo "Extracting commit message for release notes ğŸ—’ï¸..."
          body=$(git log -1 --pretty=%B | sed -n '1p')
          echo "BODY=$body" >> $GITHUB_OUTPUT

      # Step 8ï¸âƒ£: Commit and push the new version ğŸ–Šï¸
      - name: ğŸ’¾ Commit and Push Version
        if: github.ref == 'refs/heads/main'
        uses: devops-infra/action-commit-push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          commit_message: Update to version ${{ steps.update_version.outputs.VERSION }} [skip-ci]

      # Step 9ï¸âƒ£: Publish to PyPI ğŸ“¦
      - name: ğŸ›« Publish CLI to PyPI
        if: github.ref == 'refs/heads/main' # Ensure publishing happens only on the main branch
        env:
          API_KEY: '${{ secrets.PIP_API_KEY }}' # PyPI token for authentication ğŸ”‘
        run: |
          echo "Publishing package to PyPI ğŸ..."
          pip install twine
          python setup.py sdist
          twine upload dist/* -u __token__ -p $API_KEY

      # Step ğŸ”Ÿ: Build and Publish Docker Image ğŸ³
      - name: ğŸ”‘ Log in to Docker Hub ğŸ³
        if: github.ref == 'refs/heads/main' # Ensure publishing happens only on the main branch
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # DockerHub username
          password: ${{ secrets.DOCKER_API_KEY }} # DockerHub API key (used as password)
      - name: ğŸ“¦ Build and Push Docker Image
        if: github.ref == 'refs/heads/main' # Ensure publishing happens only on the main branch
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          tags: |
            haimkastner/connectivity-tool:${{ steps.update_version.outputs.VERSION }}
            haimkastner/connectivity-tool:latest
          labels: |
            org.opencontainers.image.description=$(cat DOCKER.md)
            org.opencontainers.image.authors="Haim Kastner"

      # Step 1ï¸âƒ£1ï¸âƒ£: Create a GitHub release ğŸŒŸ
      - name: ğŸ·ï¸ Create Release
        if: github.ref == 'refs/heads/main'
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.update_version.outputs.VERSION }} # Tag with the new version
          name: CLI Version ${{ steps.update_version.outputs.VERSION }}
          body: ${{ steps.version_info.outputs.BODY }}
          draft: false
          prerelease: false # Mark as stable release ğŸ‰
